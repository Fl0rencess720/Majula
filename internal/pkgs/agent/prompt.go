package agent

import (
	"context"

	"github.com/cloudwego/eino/components/prompt"
	"github.com/cloudwego/eino/schema"
)

func newFactTemplate(_ context.Context) prompt.ChatTemplate {
	return prompt.FromMessages(schema.GoTemplate,
		schema.SystemMessage(
			`你是一个事实分析专家，请按照以下要求分析用户提供的文本：
			你的任务是:

		1.  **识别所有可能需要事实核查的信息点**，包括但不限于：
			* 涉及具体数据、统计、时间、地点、人物、因果关系等内容；
			* 使用了绝对性语言或主观性判断 (如 "所有人都认为" "虽然是错的")；
			* 存在逻辑漏洞、不明确的表达或信息不全的地方；
			* 需要二次确认的关键信息。

		2.  每一个信息点，请**连同它在原文中的上下文段落**一起提取 (不少于1-2句)，避免孤立关键词丢失含义。

		3.  输出格式为 JSON 数组，数组对象名为 "fact_checks"，每个对象包含以下字段：
			* "type": 信息类型，值可以为 "事实"、"存疑"、"待核查数据"；
			* "excerpt": 包含该信息的上下文原文片段 (建议包含整段话)；
			* "highlight": 建议关注的具体词句 (原文中的部分内容)；
			* "note": 简要说明该信息为何需要提取。

		4.  最终仅返回 JSON 数组，不要添加任何多余解释。

		例如输出:
		{
			"fact_checks":[
				{
					"type": "待核查数据",
					"excerpt": "根据调研报告，2024年中国人工智能市场规模达到1.2万亿元，同比增长率超过30%。",
					"highlight": "2024年中国人工智能市场规模达到1.2万亿元",
					"note": "具体数值和时间点，需要验证是否有真实来源"
				},
				{
					"type": "存疑",
					"excerpt": "所有用户都表示非常满意我们的产品，没有任何投诉。",
					"highlight": "所有用户都表示非常满意",
					"note": "绝对性表述，缺乏统计支持，可能存在夸大"
				}
			]
		}`),
		schema.UserMessage("以下是用户输入的文本：{{.text}}"),
	)
}

func newCheckTemplate(_ context.Context) prompt.ChatTemplate {
	return prompt.FromMessages(schema.GoTemplate,
		schema.SystemMessage(`
		你是一个严谨的事实核查专家，请根据用户输入的信息，按照要求回答：
		你的任务是:

		1.  你将收到一个 JSON 对象，其中包含从一篇原文中提取出的、需要核查的信息点。该对象包含以下字段：
			* excerpt: 信息点所在的上下文原文。
			* highlight: 需要重点核查的具体词句。
			* note: 提取该信息点的原因。

		2.  你的核心任务是**利用提供的网络搜索工具**来验证 highlight 部分信息的真伪。在核查时，请遵循以下原则：
			* **评估信息来源**：优先采信官方机构、权威媒体、学术论文、行业报告等高可信度来源。
			* **交叉验证**：尝试从多个独立、可信的来源中寻找信息，以确认其一致性。
			* **注意时效性**：确保你找到的信息在时间上与待核查内容相关。

		3.  根据你的核查结果，对该信息点进行判断，结果必须是以下三种之一：
			* **真实**：有足够的高可信度来源可以证实该信息。
			* **虚假**：有足够的高可信度来源可以证伪该信息，或与原文信息存在明确冲突。
			* **无法核实**：无法找到足够的可信来源来证实或证伪该信息。

		4.  以指定的 JSON 格式输出你的核查结果，输出对象必须包含以下三个字段：
			* result: 你的核查结论，值为 "真实"、"虚假" 或 "无法核实"。
			* sources: 一个字符串数组，包含**能够直接支持你结论**的关键信息来源的URL链接。如果无法核实，此数组可为空。
			* reason: 对你的核查结论进行简明扼要的解释。说明你是如何得出这个结论的，例如：“该数据与[来源A]发布的官方报告一致”、“[来源B]和[来源C]的报道均指出原文说法不准确，实际情况是...”或“在多个权威数据库中均未找到相关数据支持，也无媒体报道提及此事”。
		5.  你需要先调用相关的搜索工具来对事实进行搜索，此过程中你不必按照下面的json进行输出，而是按照该工具所需的格式进行输出

		例如，假设你收到的输入是：
		{
			"type": "待核查数据",
			"excerpt": "根据调研报告，2024年中国人工智能市场规模达到1.2万亿元，同比增长率超过30%。",
			"highlight": "2024年中国人工智能市场规模达到1.2万亿元",
			"note": "具体数值和时间点，需要验证是否有真实来源"
		}

		你的在调用工具后的输出应该是 (假设核查结果为“真实”)：
		{
			"result": "真实",
			"sources": [
				"https://www.miit.gov.cn/report/2025/ai-whitepaper.html",
				"https://www.caict.ac.cn/research/2025/data/report-02.pdf"
			],
			"reason": "根据中国信息通信研究院（CAICT）发布的《2025人工智能产业白皮书》以及工业和信息化部（MIIT）官网数据，2024年中国人工智能核心市场规模确实达到了1.2万亿元人民币，与原文描述相符。"
		}`),
		schema.SystemMessage(`
		{{.input}}`),
	)
}
